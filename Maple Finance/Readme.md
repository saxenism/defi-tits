## To get a detailed idea about Maple visit:

[Maple Official Wiki](https://github.com/maple-labs/maple-core/wiki/)

## Brief Overview: Maple Finance

1. Decentralised corporate credit market protocol.
> **Note** This is a decentralised protocol but not trustless, since we always HAVE to assume Pool Delegates to be fair and non-malicious actors

2. Borrowers can leverage their reputations to get undercollateralized loans over time. They do so by getting access to capital pools of different Pool Delegates after liaisoning with them.

3. **Interest Compounds**: Interest is accrued and reinvested to enable capital to compound over time

4. **Pool Delegates** carry out the entire due diligence. Lenders chill out. LPs (Lenders) earn revenue by claiming interest generated by the pool.

5. Pool Delegates use Maple to attract funds, crack good deals with blue chip borrowers and then earn good performance fee. But they have to stake a good amount of MPL-USDC 50-50 BPTs (Balancer Pool Tokens) so that their incentives are aligned with the LPs.

6. After agreeing on terms with a borrower, one or more Pool Delegates will fund the loan with funds available in their pools.

7. **Stakers** are MPL holders and deposit BPT as first loss reserve against loan defaults. BPTs are burned to cover the shortfall after liquiditing the collateral of a borrower. 

8. Concept of ideal collateral ratio, grace period, late fee and liquidation post grace period exists.

9. **Governor** is a multi-sig wallet that controls the administrative functions in the protocol (admin)

10. **Contract Instance Admins** or local admins are admins for a particular task. Eg. These admins are set by:
+ Governor in case of factories
+ Pool Delegate in case of a Pool
+ Borrower in case of a loan

11. **Protocol Admin/Global Admin**: Can call only one function, that pauses every outward facing function of the protocol. Called only when things have got really bad.

## Maple Protocol Architecture

The architecture is pretty straightforward. Doesn't need much explaining.

1. There is a Pool Factory, which will create Pools, which will be managed by Pool Delegates. Simple.
+ Each pool will have a Liquidity Locker (created from its factory) to store the pool's liquidity
+ Each pool will have a Debt Locker (created from its factory) to store the debt that is given out from that particular pool
+ Each pool will have a Stake Locker (created from its factory) for the Pool Delegate to stake their MPL-USDC BPT tokens. This is where the stakers would also stake their tokens.
+ Each pool will generate some MPL rewards as a result of this staking and will be distributed among the LPs.

2. Similarly there is a Loan factory, which will be used by Borrowers to create Loan requests(contracts). Simple
+ Each loan will have a Collateral Locker (created from its factory) to store the borrower's collateral
+ Each loan will have a Funding Locker (created from its factory) **which I am not sure why it exists. Probably to store the repaid amount? IDK**

3. Ofcourse Chainlink oracles are being used to fetch prices and execute functions dependent on price action.

![Protocol Architecture](https://user-images.githubusercontent.com/35537333/117036971-fa290000-acd3-11eb-8aa4-188e6dca3a3f.png)

## Security Considerations:

1. Pool Delegates are supposed to be trusted actors. Can't really do anything if they turn out to be malicious.
2. dapp.tools (HEVM) has been used for extensive unit testing + fuzzing
> If you know anything James Bach, you'll know that he'll call this checking rather than actual testing. And this is what basically interests us here.
3. External code audits by Deduab, PeckShield, TrailOfBits, Code4rena.
4. 2 week internal audit by the Maple team
> This kind of audit is often susceptible to developer biases. But it is complimented by external audits here... So, shouldn't be much of an issue. Anyway, we are still more interested in testing rather than the auditing and the plethora of audit reports of Maple.
5. OZ Defender is in use to inform of any emergencies.
6. Incase of a oracle outage, all transactions requesting asset prices will be reverted. Manual override possible.
> Hmm interesting claim. Will be fun to check this.
7. Incase of emergencies, *contract instance admins (local admins)* and/or *protocol admins/global admins* will come into play.
8. Smart contract logic that is deployed on the mainnet cannot be altered in any way. Fuck proxies.
> This is good. Significantly reduces the surface area of possible attacks.

## Understanding Pools

If as a LP or staker you want to withdraw your funds, you'll first have to trigger a cooldown function and wait for it get over before you can withdraw your funds or even cancel your staking as a staker.

In the following image it is not depicted properly, but the Pool Delegate also has to stake a shit ton of BPTs to be whitelisted as a Pool Delegate by the MapleDAO in the first place.

![Users that can interact with a pool](https://user-images.githubusercontent.com/44272939/108764517-b457fa80-7520-11eb-9f32-73c09c278b92.png)

## Understanding Loanss

1. The Loan contracts are created by *Borrowers* out of the *LoanFactory* contracts, which are whitelisted in **MapleGlobals** to ensure that only certain types of *Loan* contracts are used in the protocol.

2. Loan contracts are used to:
+ Set terms such as:
    + APR, Payment Interval Length, Term Lenght, Collateral Ratio, Collateral and Borrow asset, etc.
+ Receiving capital from lenders
+ Withdrawing the loan
+ Interest Payments
+ Liquidating Collaterals

3. Important point to note is the use of **Payment Calculators**. These are used to calculate interest payments, late fees, premium fees etc. These are also whitelisted in the `MapleGlobals` to ensure no malicious payment calculators are used.

> At first glance this looks like a whitelisted library which will be used for calculations based on the specifications of the loans, such as simple/compound interest. This also means that no calculation would be happening inside of the Loan contract

> Need to check if these calculation libraries can somehow be tampered with.

4. A Loan can be funded by any number of pools, but those pools must be instantiated from `PoolFactory` contract itself.
The LPs get LoanFDTs.

> LoanFDTs are similar to LP Tokens as they represent a claim over a part of principal plus any proportional interest that gets generated. 

> LoanFDTs that Maple is using isn't the same old ERC20, they are using a relatively unknown ERC2222 standard. Need to check that thoroughly then.

5. Borrowers can drawdown any amount that is both above the request Loan amount, and below the current balance of the `FundingLocker`. 

> The question here is, why would Maple allow lenders to deposit funds in the Loan contract past their `requested` amount? Wouldn't that essentially be wasted amount?

6. At the time of the drawdown:
    +  a percentage of the drawdown amount is paid to the `MapleTreasury` from the `FundingLocker` as the `treasury fee`.
    + investor fee is paid to the lenders (a % of the drawdown amount). Sent from `FundingLocker` to the `Loan` to be claimed by the lenders.
    > Seems a bit off. Investigate again.
    + Drawdown minus fee is transferred to the Borrower

7. Excess funds are sent to `Loan` contract to be claimed by the lenders. 

8. Normally, interest is paid in constant amounts at regular intervals, and principal is returned on last repayment. Otherwise, you can also pay the entire remaining balance of the loan in one transaction including principal and the amount the interest that should be paid (we use a function called `PremiumCalc` here).

9. Liquidations work as usual apart from the fact that you can only call it as a pool delegate if your equity in the loan is more than the `minLoanEquity`

> This again will be interesting to test. Should already be heavily testsed.

10. Another (unnatural) thing that Maple is doing in the Liquidation is that, post the calling of liquidation, they are taking the collateral from the `CollateralLocker` and converting it into the Borrow Asset using Uniswap and then transferring it to be to the `Loan` contract for being claimed by the lenders.

> I don't understand why didn't Maple just let the lenders claim their share of the collateral in terms of collateral asset itself. Perhaps it has got to do something with the LoanFDT which is an ERC2222 instead of pure ERC20. Need to get more clarity here.